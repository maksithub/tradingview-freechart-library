!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Datafeeds={})}(this,function(e){"use strict";var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function r(e,r){function s(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(s.prototype=r.prototype,new s)}var s=!1;function o(e){if(s){var t=new Date;console.log(t.toLocaleTimeString()+"."+t.getMilliseconds()+"> "+e)}}function i(e){return void 0===e?"":"string"==typeof e?e:e.message}var n,a,u=function(){function e(e,t){this._datafeedUrl=e,this._requester=t}return e.prototype.getBars=function(e,t,r,s){var o=this,n={symbol:e.ticker||"",resolution:t,from:r,to:s};return new Promise(function(e,t){o._requester.sendRequest(o._datafeedUrl,"history",n).then(function(r){if("ok"===r.s||"no_data"===r.s){var s=[],o={noData:!1};if("no_data"===r.s)o.noData=!0,o.nextTime=r.nextTime;else for(var i=void 0!==r.v,n=void 0!==r.o,a=0;a<r.t.length;++a){var u={time:1e3*r.t[a],close:Number(r.c[a]),open:Number(r.c[a]),high:Number(r.c[a]),low:Number(r.c[a])};n&&(u.open=Number(r.o[a]),u.high=Number(r.h[a]),u.low=Number(r.l[a])),i&&(u.volume=Number(r.v[a])),s.push(u)}e({bars:s,meta:o})}else t(r.errmsg)}).catch(function(e){var r=i(e);console.warn("HistoryProvider: getBars() failed, error="+r),t(r)})})},e}(),c=function(){function e(e,t){this._subscribers={},this._requestsPending=0,this._historyProvider=e,setInterval(this._updateData.bind(this),t)}return e.prototype.subscribeBars=function(e,t,r,s){this._subscribers.hasOwnProperty(s)?o("DataPulseProvider: already has subscriber with id="+s):(this._subscribers[s]={lastBarTime:null,listener:r,resolution:t,symbolInfo:e},o("DataPulseProvider: subscribed for #"+s+" - {"+e.name+", "+t+"}"))},e.prototype.unsubscribeBars=function(e){delete this._subscribers[e],o("DataPulseProvider: unsubscribed for #"+e)},e.prototype._updateData=function(){var e=this;if(!(this._requestsPending>0)){this._requestsPending=0;var t=function(t){r._requestsPending+=1,r._updateDataForSubscriber(t).then(function(){e._requestsPending-=1,o("DataPulseProvider: data for #"+t+" updated successfully, pending="+e._requestsPending)}).catch(function(r){e._requestsPending-=1,o("DataPulseProvider: data for #"+t+" updated with error="+i(r)+", pending="+e._requestsPending)})},r=this;for(var s in this._subscribers)t(s)}},e.prototype._updateDataForSubscriber=function(e){var t=this,r=this._subscribers[e],s=parseInt((Date.now()/1e3).toString()),o=s-function(e,t){var r=0;r="D"===e||"1D"===e?t:"M"===e||"1M"===e?31*t:"W"===e||"1W"===e?7*t:t*parseInt(e)/1440;return 24*r*60*60}(r.resolution,10);return this._historyProvider.getBars(r.symbolInfo,r.resolution,o,s).then(function(r){t._onSubscriberDataReceived(e,r)})},e.prototype._onSubscriberDataReceived=function(e,t){if(this._subscribers.hasOwnProperty(e)){var r=t.bars;if(0!==r.length){var s=r[r.length-1],i=this._subscribers[e];if(!(null!==i.lastBarTime&&s.time<i.lastBarTime)){if(null!==i.lastBarTime&&s.time>i.lastBarTime){if(r.length<2)throw new Error("Not enough bars in history for proper pulse update. Need at least 2.");var n=r[r.length-2];i.listener(n)}i.lastBarTime=s.time,i.listener(s)}}}else o("DataPulseProvider: Data comes for already unsubscribed subscription #"+e)},e}();!function(e){e[e.General=0]="General",e[e.Fast=1]="Fast"}(n||(n={})),function(e){e[e.Fast=1e4]="Fast",e[e.General=6e4]="General"}(a||(a={}));var l=function(){function e(e){this._subscribers={},this._requestsPending=0,this._quotesProvider=e,setInterval(this._updateQuotes.bind(this,n.Fast),a.Fast),setInterval(this._updateQuotes.bind(this,n.General),a.General)}return e.prototype.subscribeQuotes=function(e,t,r,s){this._subscribers[s]={symbols:e,fastSymbols:t,listener:r},o("QuotesPulseProvider: subscribed quotes with #"+s)},e.prototype.unsubscribeQuotes=function(e){delete this._subscribers[e],o("QuotesPulseProvider: unsubscribed quotes with #"+e)},e.prototype._updateQuotes=function(e){var t=this;if(!(this._requestsPending>0)){var r=function(r){s._requestsPending++;var a=s._subscribers[r];s._quotesProvider.getQuotes(e===n.Fast?a.fastSymbols:a.symbols).then(function(s){t._requestsPending--,t._subscribers.hasOwnProperty(r)&&(a.listener(s),o("QuotesPulseProvider: data for #"+r+" ("+e+") updated successfully, pending="+t._requestsPending))}).catch(function(s){t._requestsPending--,o("QuotesPulseProvider: data for #"+r+" ("+e+") updated with error="+i(s)+", pending="+t._requestsPending)})},s=this;for(var a in this._subscribers)r(a)}},e}();function h(e,t,r,s){var o=e[t];return!Array.isArray(o)||s&&!Array.isArray(o[0])?o:o[r]}var f,d=function(){function e(e,t,r){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=t,this._requester=r,this._readyPromise=this._init(),this._readyPromise.catch(function(e){console.error("SymbolsStorage: Cannot init, error="+e.toString())})}return e.prototype.resolveSymbol=function(e){var t=this;return this._readyPromise.then(function(){var r=t._symbolsInfo[e];return void 0===r?Promise.reject("invalid symbol"):Promise.resolve(r)})},e.prototype.searchSymbols=function(e,t,r,s){var o=this;return this._readyPromise.then(function(){var i=[],n=0===e.length;e=e.toUpperCase();for(var a=function(s){var a=o._symbolsInfo[s];if(void 0===a)return"continue";if(r.length>0&&a.type!==r)return"continue";if(t&&t.length>0&&a.exchange!==t)return"continue";var u=a.name.toUpperCase().indexOf(e),c=a.description.toUpperCase().indexOf(e);if((n||u>=0||c>=0)&&!i.some(function(e){return e.symbolInfo===a})){var l=u>=0?u:8e3+c;i.push({symbolInfo:a,weight:l})}},u=0,c=o._symbolsList;u<c.length;u++){a(c[u])}var l=i.sort(function(e,t){return e.weight-t.weight}).slice(0,s).map(function(e){var t=e.symbolInfo;return{symbol:t.name,full_name:t.full_name,description:t.description,exchange:t.exchange,params:[],type:t.type,ticker:t.name}});return Promise.resolve(l)})},e.prototype._init=function(){for(var e=this,t=[],r={},s=0,i=this._exchangesList;s<i.length;s++){var n=i[s];r[n]||(r[n]=!0,t.push(this._requestExchangeData(n)))}return Promise.all(t).then(function(){e._symbolsList.sort(),o("SymbolsStorage: All exchanges data loaded")})},e.prototype._requestExchangeData=function(e){var t=this;return new Promise(function(r,s){t._requester.sendRequest(t._datafeedUrl,"symbol_info",{group:e}).then(function(o){try{t._onExchangeDataReceived(e,o)}catch(e){return void s(e)}r()}).catch(function(t){o("SymbolsStorage: Request data for exchange '"+e+"' failed, reason="+i(t)),r()})})},e.prototype._onExchangeDataReceived=function(e,t){var r=0;try{for(var s=t.symbol.length,o=void 0!==t.ticker;r<s;++r){var i=t.symbol[r],n=h(t,"exchange-listed",r),a=h(t,"exchange-traded",r),u=a+":"+i,c=o?h(t,"ticker",r):i,l={ticker:c,name:i,base_name:[n+":"+i],full_name:u,listed_exchange:n,exchange:a,description:h(t,"description",r),has_intraday:p(h(t,"has-intraday",r),!1),has_no_volume:p(h(t,"has-no-volume",r),!1),minmov:h(t,"minmovement",r)||h(t,"minmov",r)||0,minmove2:h(t,"minmove2",r)||h(t,"minmov2",r),fractional:h(t,"fractional",r),pricescale:h(t,"pricescale",r),type:h(t,"type",r),session:h(t,"session-regular",r),timezone:h(t,"timezone",r),supported_resolutions:p(h(t,"supported-resolutions",r,!0),this._datafeedSupportedResolutions),force_session_rebuild:h(t,"force-session-rebuild",r),has_daily:p(h(t,"has-daily",r),!0),intraday_multipliers:p(h(t,"intraday-multipliers",r,!0),["1","5","15","30","60"]),has_weekly_and_monthly:h(t,"has-weekly-and-monthly",r),has_empty_bars:h(t,"has-empty-bars",r),volume_precision:p(h(t,"volume-precision",r),0)};this._symbolsInfo[c]=l,this._symbolsInfo[i]=l,this._symbolsInfo[u]=l,this._symbolsList.push(i)}}catch(s){throw new Error("SymbolsStorage: API error when processing exchange "+e+" symbol #"+r+" ("+t.symbol[r]+"): "+s.message)}},e}();function p(e,t){return void 0!==e?e:t}function _(e,t,r){var s=e[t];return Array.isArray(s)?s[r]:s}!function(e){e[e.SearchItemsLimit=30]="SearchItemsLimit"}(f||(f={}));var m=function(){function e(e,t,r,s){void 0===s&&(s=1e4);var o=this;this._configuration={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1},this._symbolsStorage=null,this._datafeedURL=e,this._requester=r,this._historyProvider=new u(e,this._requester),this._quotesProvider=t,this._dataPulseProvider=new c(this._historyProvider,s),this._quotesPulseProvider=new l(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then(function(e){null===e&&(e={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}),o._setupWithConfiguration(e)})}return e.prototype.onReady=function(e){var t=this;this._configurationReadyPromise.then(function(){e(t._configuration)})},e.prototype.getQuotes=function(e,t,r){this._quotesProvider.getQuotes(e).then(t).catch(r)},e.prototype.subscribeQuotes=function(e,t,r,s){this._quotesPulseProvider.subscribeQuotes(e,t,r,s)},e.prototype.unsubscribeQuotes=function(e){this._quotesPulseProvider.unsubscribeQuotes(e)},e.prototype.calculateHistoryDepth=function(e,t,r){},e.prototype.getMarks=function(e,t,r,s,n){if(this._configuration.supports_marks){var a={symbol:e.ticker||"",from:t,to:r,resolution:n};this._send("marks",a).then(function(e){if(!Array.isArray(e)){for(var t=[],r=0;r<e.id.length;++r)t.push({id:_(e,"id",r),time:_(e,"time",r),color:_(e,"color",r),text:_(e,"text",r),label:_(e,"label",r),labelFontColor:_(e,"labelFontColor",r),minSize:_(e,"minSize",r)});e=t}s(e)}).catch(function(e){o("UdfCompatibleDatafeed: Request marks failed: "+i(e)),s([])})}},e.prototype.getTimescaleMarks=function(e,t,r,s,n){if(this._configuration.supports_timescale_marks){var a={symbol:e.ticker||"",from:t,to:r,resolution:n};this._send("timescale_marks",a).then(function(e){if(!Array.isArray(e)){for(var t=[],r=0;r<e.id.length;++r)t.push({id:_(e,"id",r),time:_(e,"time",r),color:_(e,"color",r),label:_(e,"label",r),tooltip:_(e,"tooltip",r)});e=t}s(e)}).catch(function(e){o("UdfCompatibleDatafeed: Request timescale marks failed: "+i(e)),s([])})}},e.prototype.getServerTime=function(e){this._configuration.supports_time&&this._send("time").then(function(t){var r=parseInt(t);isNaN(r)||e(r)}).catch(function(e){o("UdfCompatibleDatafeed: Fail to load server time, error="+i(e))})},e.prototype.searchSymbols=function(e,t,r,s){if(this._configuration.supports_search){var n={limit:f.SearchItemsLimit,query:e.toUpperCase(),type:r,exchange:t};this._send("search",n).then(function(e){if(void 0!==e.s)return o("UdfCompatibleDatafeed: search symbols error="+e.errmsg),void s([]);s(e)}).catch(function(t){o("UdfCompatibleDatafeed: Search symbols for '"+e+"' failed. Error="+i(t)),s([])})}else{if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,t,r,f.SearchItemsLimit).then(s).catch(s.bind(null,[]))}},e.prototype.resolveSymbol=function(e,t,r){o("Resolve requested");var s=Date.now();function n(e){o("Symbol resolved: "+(Date.now()-s)+"ms"),t(e)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw new Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(e).then(n).catch(r)}else{var a={symbol:e};this._send("symbols",a).then(function(e){void 0!==e.s?r("unknown_symbol"):n(e)}).catch(function(e){o("UdfCompatibleDatafeed: Error resolving symbol: "+i(e)),r("unknown_symbol")})}},e.prototype.getBars=function(e,t,r,s,o,i){this._historyProvider.getBars(e,t,r,s).then(function(e){o(e.bars,e.meta)}).catch(i)},e.prototype.subscribeBars=function(e,t,r,s,o){this._dataPulseProvider.subscribeBars(e,t,r,s)},e.prototype.unsubscribeBars=function(e){this._dataPulseProvider.unsubscribeBars(e)},e.prototype._requestConfiguration=function(){return this._send("config").catch(function(e){return o("UdfCompatibleDatafeed: Cannot get datafeed configuration - use default, error="+i(e)),null})},e.prototype._send=function(e,t){return this._requester.sendRequest(this._datafeedURL,e,t)},e.prototype._setupWithConfiguration=function(e){if(this._configuration=e,void 0===e.exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw new Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new d(this._datafeedURL,e.supported_resolutions||[],this._requester)),o("UdfCompatibleDatafeed: Initialized with "+JSON.stringify(e))},e}();var b=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype.getQuotes=function(t){return e.prototype.getQuotes.call(this,t).then(function(e){return e.forEach(function(e){"ok"===e.s&&(e.v.short_name=e.n,e.v.description=e.n)}),e})},t}(function(){function e(e,t){this._datafeedUrl=e,this._requester=t}return e.prototype.getQuotes=function(e){var t=this;return new Promise(function(r,s){t._requester.sendRequest(t._datafeedUrl,"quotes",{symbols:e}).then(function(e){"ok"===e.s?r(e.d):s(e.errmsg)}).catch(function(e){var t=i(e);o("QuotesProvider: getQuotes failed, error="+t),s("network error: "+t)})})},e}()),y=function(){function e(e){e&&(this._headers=e)}return e.prototype.sendRequest=function(e,t,r){if(void 0!==r){var s=Object.keys(r);0!==s.length&&(t+="?"),t+=s.map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e].toString())}).join("&")}o("New request: "+t);var i={credentials:"same-origin"};return void 0!==this._headers&&(i.headers=this._headers),fetch(e+"/"+t,i).then(function(e){return e.text()}).then(function(e){return JSON.parse(e)})},e}(),v=function(e){function t(t,r,s,o){void 0===o&&(o=1e4);var i=this,n=new y({Authorization:"Bearer "+r});return(i=e.call(this,t,new b(t,n),n,o)||this)._configuration=s,i._configuration.supports_group_request=!0,i}return r(t,e),t.prototype._requestConfiguration=function(){var e=this;return new Promise(function(t){setTimeout(function(){t(e._configuration)})})},t}(m);e.RestUDFCompatibleDatafeed=v,Object.defineProperty(e,"__esModule",{value:!0})});
