!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.Brokers={})}(this,function(t){"use strict";var l=Object.assign||function(t){for(var e,i=arguments,o=1,r=arguments.length;o<r;o++)for(var a in e=i[o])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},e=[{label:"Symbol",className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"symbol"},{label:"Side",className:"",property:"side",formatter:"side"},{label:"Type",className:"",property:"type",formatter:"type"},{label:"Qty",className:"tv-data-table__cell--right-align",property:"qty",help:"Size in lots"},{label:"Limit Price",className:"tv-data-table__cell--right-align",property:"limitPrice",formatter:"formatPrice"},{label:"Stop Price",className:"tv-data-table__cell--right-align",property:"stopPrice",formatter:"formatPrice"},{label:"Last",className:"tv-data-table__cell--right-align",property:"last",formatter:"formatPriceForexSup",highlightDiff:!0},{id:"status",label:"Status",className:"",property:"status",formatter:"status",supportedStatusFilters:[0]},{label:"Order id",className:"",property:"id"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"orderSettings",notSortable:!0,modificationProperty:"status"}],o=[{label:"Symbol",className:"tv-data-table__cell--symbol-cell",formatter:"symbol",property:"symbol"},{label:"Side",className:"",property:"side",formatter:"side"},{label:"Qty",className:"tv-data-table__cell--right-align",property:"qty",help:"Size in lots"},{label:"Avg Fill Price",className:"tv-data-table__cell--right-align",property:"avgPrice",formatter:"formatPrice"},{label:"Last",className:"tv-data-table__cell--right-align",property:"last",formatter:"formatPriceForexSup",highlightDiff:!0},{label:"Profit",className:"tv-data-table__cell--right-align",property:"pl",formatter:"profit"},{label:"",className:"tv-data-table__cell--buttons-cell",formatter:"posSettings",notSortable:!0,modificationProperty:"status"}],r=[{label:"",notSortable:!0,property:"title",formatter:"custom_uppercase"},{label:"Balance",className:"tv-data-table__cell--right-align",property:"balance",formatter:"fixed",fixedWidth:!0},{label:"Open PL",className:"tv-data-table__cell--right-align",property:"pl",formatter:"profit",notSortable:!0,fixedWidth:!0},{label:"Equity",className:"tv-data-table__cell--right-align",property:"equity",formatter:"fixed",notSortable:!0,fixedWidth:!0}],i=(a.prototype.connectionStatus=function(){return 1},a.prototype.chartContextMenuActions=function(t,e){return this._host.defaultContextMenuActions(t)},a.prototype.isTradable=function(t){return Promise.resolve(!0)},a.prototype.placeOrder=function(i,t){function e(t){(t.stopLoss||t.takeProfit||i.duration)&&console.log("Stop Loss, Take Profit and Duration are not implemented in this sample."),o._host.activateBottomWidget();var e={id:""+o._idsCounter++,duration:t.duration,limitPrice:t.limitPrice,profit:0,qty:t.qty,side:t.side||1,status:6,stopPrice:t.stopPrice,symbol:t.symbol,type:t.type||2};return o._updateOrder(e),Promise.resolve()}var o=this;return t?e(i):this._host.showOrderDialog(i,e).catch(function(){})},a.prototype.modifyOrder=function(t,e,i){function o(t){var e=r._orderById[t.id];if(e){var i=l({},e);i.qty=t.qty,i.stopPrice=t.stopPrice,i.limitPrice=t.limitPrice,r._updateOrder(i)}return Promise.resolve()}var r=this;return e?o(t):this._host.showOrderDialog(t,o).catch(function(){})},a.prototype.closePosition=function(t,e){function i(){return o.placeOrder({symbol:r.symbol,side:-1===r.side?1:-1,type:2,qty:r.qty},!0)}var o=this,r=this._positionById[t];return e?i():this._host.showClosePositionDialog(r.id,i)},a.prototype.orders=function(){return Promise.resolve(this._orders.slice())},a.prototype.positions=function(){return Promise.resolve(this._positions.slice())},a.prototype.executions=function(e){return Promise.resolve(this._executions.filter(function(t){return t.symbol===e}))},a.prototype.reversePosition=function(t,e){function i(){return o.placeOrder({symbol:r.symbol,side:-1===r.side?1:-1,type:2,qty:2*r.qty},!0)}var o=this,r=this._positionById[t];return e?i():this._host.showReversePositionDialog(r,i)},a.prototype.cancelOrder=function(t,e){function i(){return r.status=1,o._updateOrder(r),Promise.resolve()}var o=this,r=this._orderById[t];return e?i():this._host.showCancelOrderDialog(r.id,i)},a.prototype.cancelOrders=function(t,e,i,o){function r(){return Promise.all(i.map(function(t){return a.cancelOrder(t,!0)})).then(function(){})}var a=this;return o?r():this._host.showCancelMultipleOrdersDialog(t,e,i.length,r)},a.prototype.accountManagerInfo=function(){var i=this;return{accountTitle:"Trading Sample",summary:[{text:"Balance",wValue:this._balanceValue,formatter:"fixed"},{text:"Equity",wValue:this._equityValue,formatter:"fixed"}],customFormatters:[{name:"custom_uppercase",format:function(t){return String(t.value).toUpperCase()}}],orderColumns:e,positionColumns:o,pages:[{id:"accountsummary",title:"Account Summary",tables:[{id:"accountsummary",columns:r,getData:function(){return Promise.resolve([i._accountManagerData])},initialSorting:{columnId:"balance",asc:!1},changeDelegate:this._amChangeDelegate}]}],contextMenuActions:function(t,e){return Promise.resolve(i._bottomContextMenuItems(e))}}},a.prototype.symbolInfo=function(t){return this._host.symbolSnapshot(t).then(function(t){var e=t.minmov/t.pricescale,i=e;return{qty:{min:1,max:Number.MAX_VALUE,step:1},pipValue:1*i*1||1,pipSize:i,minTick:e,description:t.description}})},a.prototype.accountInfo=function(){return Promise.resolve({id:"Trading Sample",name:"",currency:"USD"})},a.prototype._bottomContextMenuItems=function(t){var e=this;return t.length&&t.push({separator:!0}),t.concat([{text:"Show Buy/Sell Panel",action:function(){e._host.floatingTradingPanelVisibility().setValue(!e._host.floatingTradingPanelVisibility().value())},checkable:!0,checked:this._host.floatingTradingPanelVisibility().value()},{text:"Trading Properties...",action:function(){e._host.showTradingProperties()}}])},a.prototype._buttonDropdownItems=function(){var t=this;return this._host.defaultDropdownMenuActions({showFloatingToolbar:!0}).concat([{separator:!0},{text:"Trading Properties...",action:function(){t._host.showTradingProperties()}}])},a.prototype._createPositionForOrder=function(t){var e=t.symbol,i=this._positionById[e],o=t.side,r=t.qty;if(t.avgPrice=t.price,i){var a=t.side===i.side?1:-1;if(0<a)i.avgPrice=(i.qty*i.avgPrice+t.qty*t.price)/(i.qty+t.qty);else{i.avgPrice=i.avgPrice;var s=Math.min(r,i.qty);this._accountManagerData.balance+=(t.price-i.avgPrice)*s*(-1===i.side?-1:1)}i.qty=i.qty+t.qty*a,i.qty<0&&(i.side=-1===i.side?1:-1,i.qty*=-1)}else i=l({},t,{id:e,avgPrice:t.price});var n={id:""+this._idsCounter++,brokerSymbol:t.brokerSymbol,price:t.price,qty:r,side:o,symbol:t.symbol,time:Date.now()};this._executions.push(n),this._host.executionUpdate(n),this._updatePosition(i),this._recalculateAMData()},a.prototype._updateOrderLast=function(t){this._host.orderPartialUpdate(t.id,{last:t.last})},a.prototype._updateOrder=function(i){var t,e,o,r=this,a=((t={})[-1]=((e={})[2]=function(){return!!i.price},e[1]=function(){return void 0!==i.limitPrice&&i.last>=i.limitPrice},e[3]=function(){return void 0!==i.stopPrice&&i.last<=i.stopPrice},e[4]=function(){return!1},e),t[1]=((o={})[2]=function(){return!!i.price},o[1]=function(){return void 0!==i.limitPrice&&i.last<=i.limitPrice},o[3]=function(){return void 0!==i.stopPrice&&i.last>=i.stopPrice},o[4]=function(){return!1},o),t),s=Boolean(this._orderById[i.id]);this._orderById[i.id]=i,s||(this._orders.push(i),this._subscribeData(i.symbol,i.id,function(t){if(i.last!==t){if(i.last=t,null==i.price&&(i.price=i.last),6===i.status&&a[i.side][i.type]()){var e=l({},i);delete e.status,i.price=i.last,i.avgPrice=i.last,r._createPositionForOrder(e),i.status=2,r._updateOrder(i)}r._updateOrderLast(i)}})),this._host.orderUpdate(i)},a.prototype._updatePosition=function(e){var i=this,t=Boolean(this._positionById[e.id]);if(t&&!e.qty){this._unsubscribeData(e.id);var o=this._positions.indexOf(e);return-1!==o&&this._positions.splice(o,1),delete this._positionById[e.id],void this._host.positionUpdate(e)}t||(this._positions.push(e),this._subscribeData(e.symbol,e.id,function(t){e.last!==t&&(e.last=t,e.profit=(e.last-e.price)*e.qty*(-1===e.side?-1:1),i._host.plUpdate(e.symbol,e.profit),i._host.positionPartialUpdate(e.id,e),i._recalculateAMData())})),this._positionById[e.id]=e,this._host.positionUpdate(e)},a.prototype._subscribeData=function(t,e,i){this._quotesProvider.subscribeQuotes([],[t],function(t){var e=t[0];"ok"===e.s&&"number"==typeof e.v.lp&&i(e.v.lp)},s(e))},a.prototype._unsubscribeData=function(t){this._quotesProvider.unsubscribeQuotes(s(t))},a.prototype._recalculateAMData=function(){var e=0;this._positions.forEach(function(t){e+=t.profit||0}),this._accountManagerData.pl=e,this._accountManagerData.equity=this._accountManagerData.balance+e,this._amChangeDelegate.fire(this._accountManagerData)},a);function a(t,e){var i=this;this._accountManagerData={title:"Trading Sample",balance:1e7,equity:1e7,pl:0},this._positionById={},this._positions=[],this._orderById={},this._orders=[],this._executions=[],this._idsCounter=1,this._quotesProvider=e,this._host=t,this._host.setButtonDropdownActions(this._buttonDropdownItems()),this._host.floatingTradingPanelVisibility().subscribe(function(){i._host.setButtonDropdownActions(i._buttonDropdownItems())}),this._amChangeDelegate=this._host.factory.createDelegate(),this._balanceValue=this._host.factory.createWatchedValue(this._accountManagerData.balance),this._equityValue=this._host.factory.createWatchedValue(this._accountManagerData.equity),this._amChangeDelegate.subscribe(null,function(t){i._balanceValue.setValue(t.balance),i._equityValue.setValue(t.equity)})}function s(t){return"SampleBroker-"+t}t.BrokerSample=i,Object.defineProperty(t,"__esModule",{value:!0})});
